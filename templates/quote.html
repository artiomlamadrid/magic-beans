{% extends "layout.html" %}

{% block title %}Analyze stock{% endblock %}

{% block main %}
  <h1 class="center-header">Yahoo Finance API Interface and Analysis Tool</h1>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="alert-container">
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <form method="post" action="/quote" class="mb-4 center-form">
    <div class="d-flex gap-2 mb-3">
      <input class="form-field" name="ticker" placeholder="Ticker" autofocus
             {% if stock %} value="{{ stock.ticker }}" {% endif %} required
             style="width: 100px; max-width: 100px; margin-right: 10px;">
      <select class="form-field" name="data_type" style="width: 150px; max-width: 150px;">
        <option value="info" {% if selected_data_type == "info" %}selected{% endif %}>Basic Info</option>
        <option value="history" {% if selected_data_type == "history" %}selected{% endif %}>History</option>
        <option value="dividends" {% if selected_data_type == "dividends" %}selected{% endif %}>Dividends</option>
        <option value="splits" {% if selected_data_type == "splits" %}selected{% endif %}>Splits</option>
        <option value="analysis" {% if selected_data_type == "analysis" %}selected{% endif %}>Recommendations</option>
        <option value="earnings" {% if selected_data_type == "earnings" %}selected{% endif %}>Earnings Dates</option>
        <option value="institutional_holders" {% if selected_data_type == "institutional_holders" %}selected{% endif %}>Institutional Holders</option>
        <option value="major_holders" {% if selected_data_type == "major_holders" %}selected{% endif %}>Major Holders</option>
        <option value="options" {% if selected_data_type == "options" %}selected{% endif %}>Options</option>
        <option value="sustainability" {% if selected_data_type == "sustainability" %}selected{% endif %}>Sustainability</option>
        <option value="balance_sheet" {% if selected_data_type == "balance_sheet" %}selected{% endif %}>Balance Sheet</option>
        <option value="cashflow" {% if selected_data_type == "cashflow" %}selected{% endif %}>Cash Flow</option>
        <option value="financials" {% if selected_data_type == "financials" %}selected{% endif %}>Financials</option>
      </select>
    </div>
    <div class="d-flex gap-2 justify-content-center center-buttons">
      <button class="btn btn-primary btn-md" type="submit" name="action" value="fetch_data">Fetch</button>
      <button class="btn btn-success btn-md" type="submit" name="action" value="save_data">Save</button>
      <button class="btn btn-secondary btn-md" type="submit" name="action" value="load_data">Load</button>
      <button type="submit" name="action" value="analyze_stock" class="btn btn-primary">
          Analyze
      </button>
    </div>
    
    <!-- Collapsible Analysis Parameters Section -->
    <div class="mt-3 text-center">
      <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#analysisParams" aria-expanded="false" aria-controls="analysisParams" onclick="setAnalysisParamsExpanded()">
        Configure Analysis Parameters
      </button>
      <input type="hidden" id="analysisParams_expanded" name="analysisParams_expanded" value="false">
      <div class="collapse mt-3" id="analysisParams">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title mb-4"><strong>Valuation Model Parameters</strong></h5>
            
            <!-- DCF Parameters -->
            <div class="row mb-4">
              <div class="col-12">
                <h5 class="mb-3"><strong>Discounted Cash Flow (DCF)</strong></h5>
              </div>
              <div class="col-lg-3 col-md-6 mb-2 d-flex flex-column align-items-center" style="min-width:220px;">
                <label for="dcf_years" class="form-label w-100 text-center">Projection Years
                  <sup>
                    <a tabindex="0" role="button" data-bs-toggle="popover" data-bs-trigger="focus" title="Projection Years" data-bs-content="Number of years to project future cash flows in the DCF model. Accepts 5-20. Higher values increase long-term impact.">
                      <i class="fas fa-info-circle"></i>
                    </a>
                  </sup>
                </label>
                <input type="number" class="form-control form-control-lg" id="dcf_years" name="dcf_years" value="12" min="5" max="20">
              </div>
              <div class="col-lg-3 col-md-6 mb-2" style="min-width:220px;">
                <label for="dcf_fade_years" class="form-label w-100 text-center">Fade Years
                  <sup>
                    <a tabindex="0" role="button" data-bs-toggle="popover" data-bs-trigger="focus" title="Fade Years" data-bs-content="Years over which growth fades from initial to terminal rate. Accepts 3-15. Controls how quickly growth slows.">
                      <i class="fas fa-info-circle"></i>
                    </a>
                  </sup>
                </label>
                <input type="number" class="form-control form-control-lg" id="dcf_fade_years" name="dcf_fade_years" value="8" min="3" max="15">
              </div>
              <div class="col-lg-3 col-md-6 mb-2" style="min-width:220px;">
                <label for="dcf_terminal_g" class="form-label w-100 text-center">Terminal Growth (%)
                  <sup>
                    <a tabindex="0" role="button" data-bs-toggle="popover" data-bs-trigger="focus" title="Terminal Growth Rate" data-bs-content="Perpetual growth rate after projection period (Gordon Growth). Accepts 0-10%. Typical: 2-4%.">
                      <i class="fas fa-info-circle"></i>
                    </a>
                  </sup>
                </label>
                <input type="number" class="form-control form-control-lg" id="dcf_terminal_g" name="dcf_terminal_g" value="4.0" min="0" max="10" step="0.1">
              </div>
              <div class="col-lg-3 col-md-6 mb-2" style="min-width:220px;">
                <label for="dcf_forward_uplift" class="form-label w-100 text-center">Forward Uplift (%)
                  <sup>
                    <a tabindex="0" role="button" data-bs-toggle="popover" data-bs-trigger="focus" title="Forward Uplift" data-bs-content="Adjustment for expected margin or FCF improvement. Accepts 0-50%. Typical: 5-15%.">
                      <i class="fas fa-info-circle"></i>
                    </a>
                  </sup>
                </label>
                <input type="number" class="form-control form-control-lg" id="dcf_forward_uplift" name="dcf_forward_uplift" value="10.0" min="0" max="50" step="0.1">
              </div>
            </div>
            
            <!-- DDM Parameters -->
            <div class="row mb-4">
              <div class="col-12">
                <h5 class="mb-3"><strong>Dividend Discount Model (DDM)</strong></h5>
              </div>
              <div class="col-lg-4 col-md-6 mb-2" style="min-width:220px;">
                <label for="ddm_growth_rate" class="form-label w-100 text-center">Dividend Growth Rate (%)
                  <sup>
                    <a tabindex="0" role="button" data-bs-toggle="popover" data-bs-trigger="focus" title="Dividend Growth Rate" data-bs-content="Annualized dividend growth rate for DDM. Accepts 0-20%. Typical: 3-8%.">
                      <i class="fas fa-info-circle"></i>
                    </a>
                  </sup>
                </label>
                <input type="number" class="form-control form-control-lg" id="ddm_growth_rate" name="ddm_growth_rate" value="5.0" min="0" max="20" step="0.1">
              </div>
              <div class="col-lg-4 col-md-6 mb-2" style="min-width:220px;">
                <label for="ddm_discount_rate" class="form-label w-100 text-center">Discount Rate (%)
                  <sup>
                    <a tabindex="0" role="button" data-bs-toggle="popover" data-bs-trigger="focus" title="Discount Rate" data-bs-content="Rate used to discount future dividends to present value. Accepts 3-15%. Typical: 6-9%.">
                      <i class="fas fa-info-circle"></i>
                    </a>
                  </sup>
                </label>
                <input type="number" class="form-control form-control-lg" id="ddm_discount_rate" name="ddm_discount_rate" value="7.0" min="3" max="15" step="0.1">
              </div>
              <div class="col-lg-4 col-md-6 mb-2" style="min-width:220px;">
                <label for="ddm_projection_years" class="form-label w-100 text-center">Projection Years
                  <sup>
                    <a tabindex="0" role="button" data-bs-toggle="popover" data-bs-trigger="focus" title="Projection Years (DDM)" data-bs-content="Number of years to project dividends before terminal value. Accepts 3-10.">
                      <i class="fas fa-info-circle"></i>
                    </a>
                  </sup>
                </label>
                <input type="number" class="form-control form-control-lg" id="ddm_projection_years" name="ddm_projection_years" value="5" min="3" max="10">
              </div>
            </div>
            
            <!-- P/E Parameters -->
            <div class="row mb-4">
              <div class="col-12">
                <h5 class="mb-3"><strong>P/E Analysis</strong></h5>
              </div>
              <div class="col-lg-6 col-md-6 mb-2" style="min-width:220px;">
                <div class="form-check d-flex flex-column align-items-center">
                  <input class="form-check-input" type="checkbox" id="pe_use_forward" name="pe_use_forward" checked>
                  <label class="form-check-label" for="pe_use_forward">
                    Use Forward P/E
                  </label>
                </div>
              </div>
              <div class="col-lg-6 col-md-6 mb-2" style="min-width:220px;">
                <div class="form-check d-flex flex-column align-items-center">
                  <input class="form-check-input" type="checkbox" id="pe_use_sector_premium" name="pe_use_sector_premium" checked>
                  <label class="form-check-label" for="pe_use_sector_premium">
                    Apply Sector Premium
                  </label>
                </div>
              </div>
            </div>
            
            <!-- General Parameters -->
            <div class="row mb-4">
              <div class="col-12">
                <h5 class="mb-3"><strong>General Settings</strong></h5>
              </div>
              <div class="col-lg-4 col-md-6 mb-2" style="min-width:220px;">
                <label for="general_discount_rate" class="form-label w-100 text-center">Base Discount Rate (%)
                  <sup>
                    <a tabindex="0" role="button" data-bs-toggle="popover" data-bs-trigger="focus" title="Base Discount Rate" data-bs-content="Default discount rate for all models unless overridden. Accepts 5-15%.">
                      <i class="fas fa-info-circle"></i>
                    </a>
                  </sup>
                </label>
                <input type="number" class="form-control form-control-lg" id="general_discount_rate" name="general_discount_rate" value="8.0" min="5" max="15" step="0.1">
              </div>
              <div class="col-lg-4 col-md-6 mb-2" style="min-width:220px;">
                <label for="general_terminal_growth" class="form-label w-100 text-center">Base Terminal Growth (%)
                  <sup>
                    <a tabindex="0" role="button" data-bs-toggle="popover" data-bs-trigger="focus" title="Base Terminal Growth" data-bs-content="Default perpetual growth rate for terminal value. Accepts 0-5%.">
                      <i class="fas fa-info-circle"></i>
                    </a>
                  </sup>
                </label>
                <input type="number" class="form-control form-control-lg" id="general_terminal_growth" name="general_terminal_growth" value="2.0" min="0" max="5" step="0.1">
              </div>
              <div class="col-lg-4 col-md-6 mb-2" style="min-width:220px;">
                <div class="form-check mt-4 d-flex flex-column align-items-center">
                  <input class="form-check-input" type="checkbox" id="use_enhanced_models" name="use_enhanced_models" checked>
                  <label class="form-check-label" for="use_enhanced_models">
                    Use Enhanced Models
                  </label>
                </div>
              </div>
            </div>
            
            <div class="text-end">
              <button type="button" class="btn btn-outline-secondary btn-sm" onclick="resetParameters()">Reset to Defaults</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </form>

  {% if data %}
    {% if selected_data_type == "info" %}
      <h3 class="center-header">Basic Info for {{ stock.ticker }}</h3>
      <table class="table table-bordered table-sm center-table">
        <thead>
          <tr><th>Field</th><th>Value</th></tr>
        </thead>
        <tbody>
          {% for key, value in data.items() %}
            <tr>
              <td>{{ key }}</td>
              <td>
                {% if value is iterable and value is not string and value|length > 0 and value[0] is mapping %}
                  <table class="table table-sm table-bordered mb-2">
                    <thead>
                      <tr>
                        {% for col in value[0].keys() %}
                          <th>{{ col }}</th>
                        {% endfor %}
                      </tr>
                    </thead>
                    <tbody>
                      {% for item in value %}
                        <tr>
                          {% for col in item.keys() %}
                            <td>{{ item[col] }}</td>
                          {% endfor %}
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                {% else %}
                  {{ value }}
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>

    {% elif selected_data_type == "options" %}
      <h3 class="center-header">Options for {{ stock.ticker }} (Expiration: {{ data.expiration_date }})</h3>
      <h4 class="center-header">Calls</h4>
      <table class="table table-striped table-bordered table-sm center-table">
        <thead>
          <tr>
            {% if data.calls %}
              {% for col in data.calls[0].keys() %}
                <th>{{ col }}</th>
              {% endfor %}
            {% endif %}
          </tr>
        </thead>
        <tbody>
          {% for row in data.calls %}
            <tr>
              {% for col in row.keys() %}
                <td>{{ row[col] }}</td>
              {% endfor %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
      <h4 class="center-header">Puts</h4>
      <table class="table table-striped table-bordered table-sm center-table">
        <thead>
          <tr>
            {% if data.puts %}
              {% for col in data.puts[0].keys() %}
                <th>{{ col }}</th>
              {% endfor %}
            {% endif %}
          </tr>
        </thead>
        <tbody>
          {% for row in data.puts %}
            <tr>
              {% for col in row.keys() %}
                <td>{{ row[col] }}</td>
              {% endfor %}
            </tr>
          {% endfor %}
        </tbody>
      </table>

    {% elif selected_data_type in ["history", "dividends", "splits", "analysis", "earnings", "institutional_holders", "major_holders", "sustainability", "balance_sheet", "cashflow", "financials"] %}
      <h3 class="center-header">{{ selected_data_type.replace('_', ' ').capitalize() }} for {{ stock.ticker }}</h3>
      {% if data is iterable and data|length > 0 and data[0] is mapping %}
        <table class="table table-striped table-bordered table-sm center-table">
          <thead>
            <tr>
              {% for col in data[0].keys() %}
                <th>{{ col }}</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for row in data %}
              <tr>
                {% for col in row.keys() %}
                  <td>{{ row[col] }}</td>
                {% endfor %}
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <pre class="center-table">{{ data | tojson(indent=2) }}</pre>
      {% endif %}

    {% else %}
      <pre class="center-table">{{ data | tojson(indent=2) }}</pre>
    {% endif %}

  {% endif %}

  {% if analysis %}
  <div class="mt-4">
      <h3 class="text-center">Analysis Results for {{ analysis.basic_info.ticker if analysis.basic_info else ticker }}</h3>
      
      <!-- Basic Information Card -->
      <div class="card mb-3">
          <div class="card-header">
              <h5 class="mb-0">General Overview</h5>
          </div>
          <div class="card-body">
              {% if analysis.basic_info %}
                            <div class="row">
                  <div class="col-md-6">
                      {% if analysis.basic_info.long_name %}
                      <p><strong>Company:</strong> {{ analysis.basic_info.long_name }} ({{ analysis.basic_info.ticker }})</p>
                      {% else %}
                      <p><strong>Ticker:</strong> {{ analysis.basic_info.ticker }}</p>
                      {% endif %}
                      <p><strong>Sector:</strong> {{ analysis.basic_info.sector }}</p>
                      <p><strong>Industry:</strong> {{ analysis.basic_info.industry }}</p>
                  </div>
                  <div class="col-md-6">
                      <p><strong>Market Cap:</strong> {{ analysis.basic_info.market_cap_formatted }}</p>
                      <p><strong>Current Price:</strong> {{ analysis.basic_info.current_price_formatted }}</p>
                      <p><strong>50-Day Average:</strong> {{ analysis.basic_info.ma_50_formatted }}</p>
                      <p><strong>200-Day Average:</strong> {{ analysis.basic_info.ma_200_formatted }}</p>
                  </div>
              </div>
              {% else %}
              <p class="text-muted">No basic info available</p>
              {% endif %}
          </div>
      </div>

      <!-- Valuation Results Card -->
      <div class="card mb-3">
          <div class="card-header">
              <h5 class="mb-0">Valuation Analysis</h5>
          </div>
          <div class="card-body">
              {% if analysis.valuations and analysis.valuations|length > 0 %}
              <div class="table-responsive">
                  <table class="table table-striped">
                      <thead>
                          <tr>
                              <th>Valuation Method</th>
                              <th>Fair Value</th>
                              <th>Upside/Downside</th>
                          </tr>
                      </thead>
                      <tbody>
                          {% for valuation in analysis.valuations %}
                          <tr>
                              <td>{{ valuation.method }}</td>
                              <td>{{ valuation.value_formatted }}</td>
                              <td class="{{ valuation.upside_class }}">
                                  {{ valuation.upside_formatted }}
                              </td>
                          </tr>
                          {% endfor %}
                          {% if analysis.average_valuation_formatted %}
                          <tr class="table-info font-weight-bold">
                              <td><strong>Average Fair Value</strong></td>
                              <td><strong>{{ analysis.average_valuation_formatted }}</strong></td>
                              <td class="{{ analysis.upside_class }}">
                                  <strong>{{ analysis.upside_percent_formatted }}</strong>
                              </td>
                          </tr>
                          {% endif %}
                      </tbody>
                  </table>
              </div>
              {% else %}
              <p class="text-muted">Unable to calculate valuations - insufficient data or analysis errors.</p>
              {% endif %}
          </div>
      </div>

      <!-- Investment Summary Card -->
      <div class="card mb-3">
          <div class="card-header">
              <h5 class="mb-0">Investment Summary</h5>
          </div>
          <div class="card-body">
              {% if analysis.investment_summary %}
              <div class="row">
                  <div class="col-md-6">
                      <h6>Technical Position</h6>
                      <p class="mb-2">
                          <strong>Relative to Moving Averages:</strong><br>
                          {{ analysis.investment_summary.ma_position }}
                      </p>
                      {% if analysis.investment_summary.trend_description %}
                      <p class="mb-2">
                          <strong>Trend:</strong> {{ analysis.investment_summary.trend_description }}
                      </p>
                      {% endif %}
                  </div>
                  <div class="col-md-6">
                      <h6>Valuation Assessment</h6>
                      {% if analysis.investment_summary.valuation_summary %}
                      <p class="mb-2">
                          <strong>Fair Value Assessment:</strong><br>
                          {{ analysis.investment_summary.valuation_summary }}
                      </p>
                      {% endif %}
                      {% if analysis.investment_summary.upside_summary %}
                      <p class="mb-2">
                          <strong>Potential:</strong> {{ analysis.investment_summary.upside_summary }}
                      </p>
                      {% endif %}
                  </div>
              </div>
              
              <div class="row mt-3">
                  <div class="col-md-6">
                      {% if analysis.is_hypergrowth %}
                      <p class="mt-2">
                          <small class="text-warning">
                              <strong>Hypergrowth Analysis:</strong> This company shows characteristics of rapid growth, 
                              so valuation models may be less reliable than for mature companies.
                          </small>
                      </p>
                      {% else %}
                      <p class="mt-2">
                          <small class="text-muted">
                              Standard valuation models applied - suitable for mature company analysis.
                          </small>
                      </p>
                      {% endif %}
                  </div>
                  <div class="col-md-6">
                      <h6>Analyst Consensus</h6>
                      {% if analysis.analyst_consensus %}
                      <span class="badge badge-secondary badge-lg p-2">
                          {{ analysis.analyst_consensus.consensus }}
                      </span>
                      <p class="mt-2">
                          <small>
                              Bullish: {{ analysis.analyst_consensus.bullish_formatted }} | 
                              Neutral: {{ analysis.analyst_consensus.neutral_formatted }} | 
                              Bearish: {{ analysis.analyst_consensus.bearish_formatted }}
                          </small>
                      </p>
                      <p><small>Sentiment Score: {{ analysis.analyst_consensus.sentiment_formatted }}</small></p>
                      {% else %}
                      <span class="badge badge-secondary badge-lg p-2">No Data Available</span>
                      {% endif %}
                  </div>
              </div>
              {% else %}
              <p class="text-muted">Unable to generate investment summary - insufficient data.</p>
              {% endif %}
          </div>
      </div>


  </div>
  {% endif %}

  <script>
  function resetParameters() {
      // Reset DCF parameters
      document.getElementById('dcf_years').value = '12';
      document.getElementById('dcf_fade_years').value = '8';
      document.getElementById('dcf_terminal_g').value = '4.0';
      document.getElementById('dcf_forward_uplift').value = '10.0';
      
      // Reset DDM parameters
      document.getElementById('ddm_growth_rate').value = '5.0';
      document.getElementById('ddm_discount_rate').value = '7.0';
      document.getElementById('ddm_projection_years').value = '5';
      
      // Reset P/E parameters
      document.getElementById('pe_use_forward').checked = true;
      document.getElementById('pe_use_sector_premium').checked = true;
      
      // Reset general parameters
      document.getElementById('general_discount_rate').value = '8.0';
      document.getElementById('general_terminal_growth').value = '2.0';
      document.getElementById('use_enhanced_models').checked = true;
  }
  function setAnalysisParamsExpanded() {
      document.getElementById('analysisParams_expanded').value = 'true';
  }
  // On page load, reset the collapsed state (default should be collapsed)
  document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('analysisParams_expanded').value = 'false';
  });
  // Enable Bootstrap popovers
  document.addEventListener('DOMContentLoaded', function() {
    var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
    popoverTriggerList.forEach(function (popoverTriggerEl) {
      new bootstrap.Popover(popoverTriggerEl, { trigger: 'click' });
    });
  });
  </script>
{% endblock %}
