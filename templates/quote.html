{% extends "layout.html" %}

{% block title %}Quote{% endblock %}

{% block main %}
  <h1 class="center-header">Yahoo Finance API interface</h1>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="alert-container">
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <form method="post" action="/quote" class="mb-4 center-form">
    <div class="d-flex gap-2 mb-3">
      <input class="form-field" name="ticker" placeholder="Ticker" autofocus
             {% if stock %} value="{{ stock.ticker }}" {% endif %} required
             style="width: 100px; max-width: 100px; margin-right: 10px;">
      <select class="form-field" name="data_type" style="width: 150px; max-width: 150px;">
        <option value="info" {% if selected_data_type == "info" %}selected{% endif %}>Basic Info</option>
        <option value="history" {% if selected_data_type == "history" %}selected{% endif %}>History</option>
        <option value="dividends" {% if selected_data_type == "dividends" %}selected{% endif %}>Dividends</option>
        <option value="splits" {% if selected_data_type == "splits" %}selected{% endif %}>Splits</option>
        <option value="analysis" {% if selected_data_type == "analysis" %}selected{% endif %}>Recommendations</option>
        <option value="earnings" {% if selected_data_type == "earnings" %}selected{% endif %}>Earnings Dates</option>
        <option value="institutional_holders" {% if selected_data_type == "institutional_holders" %}selected{% endif %}>Institutional Holders</option>
        <option value="major_holders" {% if selected_data_type == "major_holders" %}selected{% endif %}>Major Holders</option>
        <option value="options" {% if selected_data_type == "options" %}selected{% endif %}>Options</option>
        <option value="sustainability" {% if selected_data_type == "sustainability" %}selected{% endif %}>Sustainability</option>
        <option value="balance_sheet" {% if selected_data_type == "balance_sheet" %}selected{% endif %}>Balance Sheet</option>
        <option value="cashflow" {% if selected_data_type == "cashflow" %}selected{% endif %}>Cash Flow</option>
        <option value="financials" {% if selected_data_type == "financials" %}selected{% endif %}>Financials</option>
      </select>
    </div>
    <div class="d-flex gap-2 justify-content-center center-buttons">
      <button class="btn btn-primary btn-md" type="submit" name="action" value="fetch_data">Fetch</button>
      <button class="btn btn-success btn-md" type="submit" name="action" value="save_data"
              {% if not session.get('fetched', {}).get(selected_data_type) %}disabled{% endif %}>Save</button>
      <button class="btn btn-secondary btn-md" type="submit" name="action" value="load_data">Load</button>
      <button type="submit" name="action" value="analyze_stock" class="btn btn-primary">
          <i class="fas fa-chart-line"></i> Analyze
      </button>
    </div>
  </form>

  {% if data %}
    {% if selected_data_type == "info" %}
      <h3 class="center-header">Basic Info for {{ stock.ticker }}</h3>
      <table class="table table-bordered table-sm center-table">
        <thead>
          <tr><th>Field</th><th>Value</th></tr>
        </thead>
        <tbody>
          {% for key, value in data.items() %}
            <tr>
              <td>{{ key }}</td>
              <td>
                {% if value is iterable and value is not string and value|length > 0 and value[0] is mapping %}
                  <table class="table table-sm table-bordered mb-2">
                    <thead>
                      <tr>
                        {% for col in value[0].keys() %}
                          <th>{{ col }}</th>
                        {% endfor %}
                      </tr>
                    </thead>
                    <tbody>
                      {% for item in value %}
                        <tr>
                          {% for col in item.keys() %}
                            <td>{{ item[col] }}</td>
                          {% endfor %}
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                {% else %}
                  {{ value }}
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>

    {% elif selected_data_type == "options" %}
      <h3 class="center-header">Options for {{ stock.ticker }} (Expiration: {{ data.expiration_date }})</h3>
      <h4 class="center-header">Calls</h4>
      <table class="table table-striped table-bordered table-sm center-table">
        <thead>
          <tr>
            {% if data.calls %}
              {% for col in data.calls[0].keys() %}
                <th>{{ col }}</th>
              {% endfor %}
            {% endif %}
          </tr>
        </thead>
        <tbody>
          {% for row in data.calls %}
            <tr>
              {% for col in row.keys() %}
                <td>{{ row[col] }}</td>
              {% endfor %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
      <h4 class="center-header">Puts</h4>
      <table class="table table-striped table-bordered table-sm center-table">
        <thead>
          <tr>
            {% if data.puts %}
              {% for col in data.puts[0].keys() %}
                <th>{{ col }}</th>
              {% endfor %}
            {% endif %}
          </tr>
        </thead>
        <tbody>
          {% for row in data.puts %}
            <tr>
              {% for col in row.keys() %}
                <td>{{ row[col] }}</td>
              {% endfor %}
            </tr>
          {% endfor %}
        </tbody>
      </table>

    {% elif selected_data_type in ["history", "dividends", "splits", "analysis", "earnings", "institutional_holders", "major_holders", "sustainability", "balance_sheet", "cashflow", "financials"] %}
      <h3 class="center-header">{{ selected_data_type.replace('_', ' ').capitalize() }} for {{ stock.ticker }}</h3>
      {% if data is iterable and data|length > 0 and data[0] is mapping %}
        <table class="table table-striped table-bordered table-sm center-table">
          <thead>
            <tr>
              {% for col in data[0].keys() %}
                <th>{{ col }}</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for row in data %}
              <tr>
                {% for col in row.keys() %}
                  <td>{{ row[col] }}</td>
                {% endfor %}
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <pre class="center-table">{{ data | tojson(indent=2) }}</pre>
      {% endif %}

    {% else %}
      <pre class="center-table">{{ data | tojson(indent=2) }}</pre>
    {% endif %}
  {% elif stock %}
    <p class="center-header">No data available for {{ stock.ticker }}.</p>
  {% endif %}

  {% if analysis %}
  <div class="mt-4">
      <div class="alert alert-info">
          <strong>Debug Info:</strong> Analysis data received for {{ analysis.basic_info.ticker if analysis.basic_info else 'Unknown' }}
      </div>
  </div>

  <div class="mt-4">
      <h3 class="text-center">ðŸ“Š Stock Analysis Results for {{ analysis.basic_info.ticker if analysis.basic_info else ticker }}</h3>
      
      <!-- Basic Information Card -->
      <div class="card mb-3">
          <div class="card-header">
              <h5 class="mb-0">ðŸ“ˆ Market Overview</h5>
          </div>
          <div class="card-body">
              {% if analysis.basic_info %}
                            <div class="row">
                  <div class="col-md-6">
                      <p><strong>Sector:</strong> {{ analysis.basic_info.sector }}</p>
                      <p><strong>Industry:</strong> {{ analysis.basic_info.industry }}</p>
                      <p><strong>Market Cap:</strong> {{ analysis.basic_info.market_cap_formatted }}</p>
                  </div>
                  <div class="col-md-6">
                      <p><strong>Current Price:</strong> {{ analysis.basic_info.current_price_formatted }}</p>
                      <p><strong>50-Day Average:</strong> {{ analysis.basic_info.ma_50_formatted }}</p>
                      <p><strong>200-Day Average:</strong> {{ analysis.basic_info.ma_200_formatted }}</p>
                  </div>
              </div>
              {% else %}
              <p class="text-muted">No basic info available</p>
              {% endif %}
          </div>
      </div>

      <!-- Valuation Results Card -->
      <div class="card mb-3">
          <div class="card-header">
              <h5 class="mb-0">ðŸ’° Valuation Analysis</h5>
          </div>
          <div class="card-body">
              {% if analysis.valuations and analysis.valuations|length > 0 %}
              <div class="table-responsive">
                  <table class="table table-striped">
                      <thead>
                          <tr>
                              <th>Valuation Method</th>
                              <th>Fair Value</th>
                              <th>Current Price</th>
                              <th>Upside/Downside</th>
                          </tr>
                      </thead>
                      <tbody>
                          {% for valuation in analysis.valuations %}
                          <tr>
                              <td>{{ valuation.method }}</td>
                              <td>{{ valuation.value_formatted }}</td>
                              <td>{{ analysis.basic_info.current_price_formatted }}</td>
                              <td class="{{ valuation.upside_class }}">
                                  {{ valuation.upside_formatted }}
                              </td>
                          </tr>
                          {% endfor %}
                          {% if analysis.average_valuation_formatted %}
                          <tr class="table-info font-weight-bold">
                              <td><strong>Average Fair Value</strong></td>
                              <td><strong>{{ analysis.average_valuation_formatted }}</strong></td>
                              <td><strong>{{ analysis.basic_info.current_price_formatted }}</strong></td>
                              <td class="{{ analysis.upside_class }}">
                                  <strong>{{ analysis.upside_percent_formatted }}</strong>
                              </td>
                          </tr>
                          {% endif %}
                      </tbody>
                  </table>
              </div>
              {% else %}
              <p class="text-muted">Unable to calculate valuations - insufficient data or analysis errors.</p>
              {% endif %}
          </div>
      </div>

      <!-- Recommendations Card -->
      <div class="card mb-3">
          <div class="card-header">
              <h5 class="mb-0">ðŸŽ¯ Investment Recommendations</h5>
          </div>
          <div class="card-body">
              <div class="row">
                  <div class="col-md-6">
                      <h6>Our Analysis</h6>
                      <span class="badge badge-{{ analysis.recommendation_class }} badge-lg p-2">
                          {{ analysis.our_recommendation }}
                      </span>
                      {% if analysis.is_hypergrowth %}
                      <p class="mt-2"><small class="text-info"><i class="fas fa-rocket"></i> Analyzed using Hypergrowth Framework</small></p>
                      {% endif %}
                  </div>
                  <div class="col-md-6">
                      <h6>Analyst Consensus</h6>
                      {% if analysis.analyst_consensus %}
                      <span class="badge badge-secondary badge-lg p-2">
                          {{ analysis.analyst_consensus.consensus }}
                      </span>
                      <p class="mt-2">
                          <small>
                              Bullish: {{ analysis.analyst_consensus.bullish_formatted }} | 
                              Neutral: {{ analysis.analyst_consensus.neutral_formatted }} | 
                              Bearish: {{ analysis.analyst_consensus.bearish_formatted }}
                          </small>
                      </p>
                      <p><small>Sentiment Score: {{ analysis.analyst_consensus.sentiment_formatted }}</small></p>
                      {% else %}
                      <span class="badge badge-secondary badge-lg p-2">No Data Available</span>
                      {% endif %}
                  </div>
              </div>
          </div>
      </div>

      <!-- Technical Analysis Card -->
      {% if analysis.technical_analysis %}
      <div class="card mb-3">
          <div class="card-header">
              <h5 class="mb-0">ðŸ“Š Technical Analysis</h5>
          </div>
          <div class="card-body">
              <div class="row">
                  <div class="col-md-4">
                      <p><strong>50-Day MA Trend:</strong> 
                          <span class="{{ analysis.technical_analysis.ma_50_class }}">
                              {{ analysis.technical_analysis.trend_50 }} ({{ analysis.technical_analysis.ma_50_formatted }})
                          </span>
                      </p>
                  </div>
                  <div class="col-md-4">
                      <p><strong>200-Day MA Trend:</strong> 
                          <span class="{{ analysis.technical_analysis.ma_200_class }}">
                              {{ analysis.technical_analysis.trend_200 }} ({{ analysis.technical_analysis.ma_200_formatted }})
                          </span>
                      </p>
                  </div>
                  <div class="col-md-4">
                      <p><strong>Overall Trend:</strong> 
                          <span class="{{ analysis.technical_analysis.overall_class }}">
                              {{ analysis.technical_analysis.overall_trend }}
                          </span>
                      </p>
                  </div>
              </div>
          </div>
      </div>
      {% endif %}
  </div>
  {% else %}
  <!-- Debug: No analysis data received -->
  <div class="mt-4" style="display: none;">
      <div class="alert alert-warning">
          Debug: No analysis data in template context
      </div>
  </div>
  {% endif %}
{% endblock %}