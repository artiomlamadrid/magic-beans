{% extends "layout.html" %}

{% block title %}Quote{% endblock %}

{% block main %}
  <h1 class="center-header">Yahoo Finance API interface</h1>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="center-alert">
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <form method="post" action="/quote" class="mb-4 center-form">
    <div class="d-flex gap-2 mb-3">
      <input class="form-field" name="ticker" placeholder="Ticker" autofocus
             {% if stock %} value="{{ stock.ticker }}" {% endif %} required
             style="width: 100px; max-width: 100px; margin-right: 10px;">
      <select class="form-field" name="data_type" style="width: 150px; max-width: 150px;">
        <option value="info" {% if selected_data_type == "info" %}selected{% endif %}>Basic Info</option>
        <option value="history" {% if selected_data_type == "history" %}selected{% endif %}>History</option>
        <option value="dividends" {% if selected_data_type == "dividends" %}selected{% endif %}>Dividends</option>
        <option value="splits" {% if selected_data_type == "splits" %}selected{% endif %}>Splits</option>
        <option value="analysis" {% if selected_data_type == "analysis" %}selected{% endif %}>Recommendations</option>
        <option value="earnings" {% if selected_data_type == "earnings" %}selected{% endif %}>Earnings Dates</option>
        <option value="institutional_holders" {% if selected_data_type == "institutional_holders" %}selected{% endif %}>Institutional Holders</option>
        <option value="major_holders" {% if selected_data_type == "major_holders" %}selected{% endif %}>Major Holders</option>
        <option value="options" {% if selected_data_type == "options" %}selected{% endif %}>Options</option>
        <option value="sustainability" {% if selected_data_type == "sustainability" %}selected{% endif %}>Sustainability</option>
        <option value="balance_sheet" {% if selected_data_type == "balance_sheet" %}selected{% endif %}>Balance Sheet</option>
        <option value="cashflow" {% if selected_data_type == "cashflow" %}selected{% endif %}>Cash Flow</option>
        <option value="financials" {% if selected_data_type == "financials" %}selected{% endif %}>Financials</option>
      </select>
    </div>
    <div class="d-flex gap-2 justify-content-center center-buttons">
      <button class="btn btn-primary btn-md" type="submit" name="action" value="fetch_data">Fetch</button>
      <button class="btn btn-success btn-md" type="submit" name="action" value="save_data"
              {% if not session.get('fetched', {}).get(selected_data_type) %}disabled{% endif %}>Save</button>
      <button class="btn btn-secondary btn-md" type="submit" name="action" value="load_data">Load</button>
    </div>
  </form>

  {% if data %}
    {% if selected_data_type == "info" %}
      <h3 class="center-header">Basic Info for {{ stock.ticker }}</h3>
      <table class="table table-bordered table-sm center-table">
        <thead>
          <tr><th>Field</th><th>Value</th></tr>
        </thead>
        <tbody>
          {% for key, value in data.items() %}
            <tr>
              <td>{{ key }}</td>
              <td>
                {% if value is iterable and value is not string and value|length > 0 and value[0] is mapping %}
                  <table class="table table-sm table-bordered mb-2">
                    <thead>
                      <tr>
                        {% for col in value[0].keys() %}
                          <th>{{ col }}</th>
                        {% endfor %}
                      </tr>
                    </thead>
                    <tbody>
                      {% for item in value %}
                        <tr>
                          {% for col in item.keys() %}
                            <td>{{ item[col] }}</td>
                          {% endfor %}
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                {% else %}
                  {{ value }}
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>

    {% elif selected_data_type == "options" %}
      <h3 class="center-header">Options for {{ stock.ticker }} (Expiration: {{ data.expiration_date }})</h3>
      <h4 class="center-header">Calls</h4>
      <table class="table table-striped table-bordered table-sm center-table">
        <thead>
          <tr>
            {% if data.calls %}
              {% for col in data.calls[0].keys() %}
                <th>{{ col }}</th>
              {% endfor %}
            {% endif %}
          </tr>
        </thead>
        <tbody>
          {% for row in data.calls %}
            <tr>
              {% for col in row.keys() %}
                <td>{{ row[col] }}</td>
              {% endfor %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
      <h4 class="center-header">Puts</h4>
      <table class="table table-striped table-bordered table-sm center-table">
        <thead>
          <tr>
            {% if data.puts %}
              {% for col in data.puts[0].keys() %}
                <th>{{ col }}</th>
              {% endfor %}
            {% endif %}
          </tr>
        </thead>
        <tbody>
          {% for row in data.puts %}
            <tr>
              {% for col in row.keys() %}
                <td>{{ row[col] }}</td>
              {% endfor %}
            </tr>
          {% endfor %}
        </tbody>
      </table>

    {% elif selected_data_type in ["history", "dividends", "splits", "analysis", "earnings", "institutional_holders", "major_holders", "sustainability", "balance_sheet", "cashflow", "financials"] %}
      <h3 class="center-header">{{ selected_data_type.replace('_', ' ').capitalize() }} for {{ stock.ticker }}</h3>
      {% if data is iterable and data|length > 0 and data[0] is mapping %}
        <table class="table table-striped table-bordered table-sm center-table">
          <thead>
            <tr>
              {% for col in data[0].keys() %}
                <th>{{ col }}</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for row in data %}
              <tr>
                {% for col in row.keys() %}
                  <td>{{ row[col] }}</td>
                {% endfor %}
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <pre class="center-table">{{ data | tojson(indent=2) }}</pre>
      {% endif %}

    {% else %}
      <pre class="center-table">{{ data | tojson(indent=2) }}</pre>
    {% endif %}
  {% elif stock %}
    <p class="center-header">No data available for {{ stock.ticker }}.</p>
  {% endif %}
{% endblock %}