{% extends "layout.html" %}

{% block title %}Quote{% endblock %}

{% block main %}
  <h1>Stock Quote</h1>

  <form method="post" action="/quote" class="mb-4">
    <input class="form-control w-auto d-inline" name="ticker" placeholder="Ticker" autofocus
           {% if stock %} value="{{ stock.ticker }}" {% endif %} required>

    <select name="data_type" class="form-select w-auto d-inline">
      <option value="info" {% if selected_data_type == "info" %}selected{% endif %}>Basic Info</option>
      <option value="history" {% if selected_data_type == "history" %}selected{% endif %}>History</option>
      <option value="dividends" {% if selected_data_type == "dividends" %}selected{% endif %}>Dividends</option>
      <option value="splits" {% if selected_data_type == "splits" %}selected{% endif %}>Splits</option>
    </select>

    <button class="btn btn-primary" type="submit" name="action" value="fetch_data">Fetch</button>
    <button class="btn btn-success" type="submit" name="action" value="save_data"
      {% if not session.fetched or not session.fetched.get(selected_data_type) %} disabled {% endif %}>
      Save
    </button>
    <button class="btn btn-secondary" type="submit" name="action" value="load_data">Load</button>
    <button class="btn btn-info" type="submit" name="action" value="view_data"
      {% if not stock %} disabled {% endif %}>
      View
    </button>
  </form>

  {% if message %}
    <div class="alert alert-info">{{ message }}</div>
  {% endif %}

  {% if data %}
    {% if selected_data_type == "info" %}
      <table class="table table-bordered table-sm">
        <thead>
          <tr><th>Field</th><th>Value</th></tr>
        </thead>
        <tbody>
          {% for key, value in data.items() %}
            <tr>
              <td>{{ key }}</td>
              <td>
                {% if key == "companyOfficers" and value is iterable and value|length > 0 %}
                  <table class="table table-sm table-bordered mb-2">
                    <thead>
                      <tr>
                        {% for col in value[0].keys() %}
                          <th>{{ col }}</th>
                        {% endfor %}
                      </tr>
                    </thead>
                    <tbody>
                      {% for officer in value %}
                        <tr>
                          {% for col in officer.keys() %}
                            <td>{{ officer[col] }}</td>
                          {% endfor %}
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>

                {% elif key == "corporateActions" and value is iterable and value|length > 0 %}
                  <table class="table table-sm table-bordered mb-2">
                    <thead>
                      <tr>
                        {% for col in value[0].keys() %}
                          <th>{{ col }}</th>
                        {% endfor %}
                      </tr>
                    </thead>
                    <tbody>
                      {% for action in value %}
                        <tr>
                          {% for col in action.keys() %}
                            <td>
                              {% if action[col] is mapping %}
                                <table class="table table-borderless table-sm mb-0">
                                  <tbody>
                                    {% for subkey, subval in action[col].items() %}
                                      <tr>
                                        <td><strong>{{ subkey }}</strong></td>
                                        <td>{{ subval }}</td>
                                      </tr>
                                    {% endfor %}
                                  </tbody>
                                </table>
                              {% else %}
                                {{ action[col] }}
                              {% endif %}
                            </td>
                          {% endfor %}
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>

                {% else %}
                  {{ value }}
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>

    {% elif selected_data_type in ["history", "dividends", "splits"] %}
      <h3>{{ selected_data_type.capitalize() }}</h3>

      {% if data is iterable and data|length > 0 and data[0] is mapping %}
        <table class="table table-striped table-bordered table-sm">
          <thead>
            <tr>
              {% for col in data[0].keys() %}
                <th>{{ col }}</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for row in data %}
              <tr>
                {% for col in row.keys() %}
                  <td>{{ row[col] }}</td>
                {% endfor %}
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <p>No data available.</p>
      {% endif %}

      
    {% else %}
      <pre>{{ data | tojson(indent=2) }}</pre>
    {% endif %}
  {% endif %}
{% endblock %}